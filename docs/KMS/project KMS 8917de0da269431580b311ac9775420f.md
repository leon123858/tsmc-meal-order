# project KMS

## DEMO

note: ç›®å‰è³‡æ–™åº«æœªé–‹å•Ÿ, å¯ä»¥è©¦æ‰“, éŒ¯èª¤ç‚ºæ­£å¸¸ç‹€æ…‹, ä¸»è¦ä¾›æŸ¥çœ‹ API ä»‹é¢

- user: [https://user-kt6w747drq-de.a.run.app/swagger/index.html](https://user-kt6w747drq-de.a.run.app/swagger/index.html)
- mail: [https://mail-kt6w747drq-de.a.run.app/swagger/index.html](https://mail-kt6w747drq-de.a.run.app/swagger/index.html)
- order: [https://order-kt6w747drq-de.a.run.app/swagger/index.html](https://order-kt6w747drq-de.a.run.app/swagger/index.html)
- menu: [https://menu-kt6w747drq-de.a.run.app/swagger/index.html](https://menu-kt6w747drq-de.a.run.app/swagger/index.html)
- storage: [https://storage-kt6w747drq-de.a.run.app](https://storage-kt6w747drq-de.a.run.app/)
    - [https://github.com/leon123858/tsmc-meal-order/tree/main/functions/storage](https://github.com/leon123858/tsmc-meal-order/tree/main/functions/storage)
- web: [https://web-kt6w747drq-de.a.run.app/](https://web-kt6w747drq-de.a.run.app/)
- ai: [https://ai-kt6w747drq-de.a.run.app/docs](https://ai-kt6w747drq-de.a.run.app/docs)

å…¶ä»–æœå‹™å¾…é–‹æ”¾

test user in prod env:

```
admin:
	email: 'test123@tsmc.bunny.com',
  password: '123456',
	uid: '4bCkldMFxoh5kP9byf7GUFsiF2t2'

normal:
	uid: 'Kkyb8oszawYXhfP6GpTNRb711F02'
```

![Untitled](project%20KMS%208917de0da269431580b311ac9775420f/Untitled.png)

![Untitled](project%20KMS%208917de0da269431580b311ac9775420f/Untitled%201.png)

web firebase config

```json
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "xxxxxxxxxxxxxxxxxxx",
  authDomain: "tw-rd-ca-leon-lin.firebaseapp.com",
  projectId: "tw-rd-ca-leon-lin",
  storageBucket: "tw-rd-ca-leon-lin.appspot.com",
  messagingSenderId: "77786086397",
  appId: "1:77786086397:web:1dee69346fa2c141917794"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
```

## æ¦‚å¿µåˆ†äº«

### event sync API

concept: æœå‹™é–“é€é message queue é€²è¡Œä»¥äº‹ä»¶é©…å‹•ç‚ºä¸»é«”çš„æºé€š

case:

æ–°ä½¿ç”¨è€…åŠ å…¥ç³»çµ±, 

1. The user service receives a login request.
2. If it identifies the user as a new user, it publishes the information to a message queue (MQ).
3. The order service is supported by a subscription infrastructure, which may receive a user-create-event.
4. The subscriber invokes the order service's HTTP API, sending a POST request with the event message included in the request body.
5. The order service is responsible for handling this request.

åƒè€ƒ:

[https://cloud.google.com/run/docs/tutorials/pubsub](https://cloud.google.com/run/docs/tutorials/pubsub)

ç¯„ä¾‹ in user service :

[https://github.com/leon123858/tsmc-meal-order/blob/main/user/controller/event.go](https://github.com/leon123858/tsmc-meal-order/blob/main/user/controller/event.go)

åŠŸèƒ½æ¸¬è©¦è…³æœ¬, åªè¦å¯ä»¥ handle æ­¤è…³æœ¬è¡¨ç¤ºé–‹ç™¼å®Œæˆ (å¯é€éè§€å¯Ÿæ­¤è…³æœ¬å¾—çŸ¥è¼¸å…¥å‹åˆ¥):

[https://github.com/leon123858/tsmc-meal-order/blob/main/user/test/trigger-sync.js](https://github.com/leon123858/tsmc-meal-order/blob/main/user/test/trigger-sync.js)

è£œå…… C# part (`é‡è¦: å’Œ golang ä¸åŒ`)

åŠŸèƒ½æ¸¬è©¦è…³æœ¬åƒè€ƒ(éœ€æ›´æ”¹åƒæ•¸, ç›®å‰ç‚º mail æ¨¡çµ„çš„åŠŸèƒ½æ¸¬è©¦)

[https://github.com/leon123858/tsmc-meal-order/blob/main/mail/mail/script/mq-event-test.js](https://github.com/leon123858/tsmc-meal-order/blob/main/mail/mail/script/mq-event-test.js)

ç¯„ä¾‹ä»£ç¢¼

```csharp
[HttpPost("event/{type}")]
[ProducesResponseType(StatusCodes.Status200OK, Type = typeof(string))]
[ProducesResponseType(StatusCodes.Status400BadRequest, Type = typeof(string))]
public ActionResult<string> SendMail(string type, PubSubMessage message)
```

```csharp
public class PubSubMessage
{
    public Message Message { get; set; }
}

public class Message
{
    public Message()
    {
    }

    public Message(string messageId, string publishTime, string data)
    {
        MessageId = messageId;
        PublishTime = publishTime;
        Data = data;
    }

    public string MessageId { get; set; }
    public string PublishTime { get; set; }
    public string Data { get; set; }
}
```

```csharp
public static string ReceiveMessageData(PubSubMessage message)
{
        var base64EncodedBytes = Convert.FromBase64String(message.Message.Data);
        // base64EncodedBytes is a byte array, so you may need to convert it to a string
        var data = Encoding.UTF8.GetString(base64EncodedBytes);
        return data;
}
```

ç”±ä¸Šæ–¹ä¸‰æ®µç¨‹å¼ç¢¼å–å¾—çš„ string å³ç‚º publisher ç«¯å‚³å‡ºçš„ struct

ä»¥ user æ¨¡çµ„ç‚ºä¾‹, æ‡‰ç‚ºä»¥ä¸‹ç¯„ä¾‹

```json
{
    type : 'user-create',
    data : {
        uid : 'Pn0Ha5NmovoWGJbNPjY0mA0tlxO4',
        email : 'test@test.test',
        userType : 'admin',
    }
}
```

### åœ°ç«¯/é›²ç«¯é–‹ç™¼ç’°å¢ƒè‡ªå‹•è¨­ç½®

éœ€æŠ½å‡ºè¨­ç½®å¸¸æ•¸, ä½¿é›²ç«¯ç™¼å¸ƒå¯ä»¥å’Œåœ°ç«¯æ¸¬è©¦ç’°å¢ƒå•Ÿå‹•åŒæ™‚å­˜åœ¨æ–¼ code ä¸­

å¾Œç«¯åƒè€ƒ: 

[https://github.com/leon123858/tsmc-meal-order/tree/main/mail/mail](https://github.com/leon123858/tsmc-meal-order/tree/main/mail/mail)

æ³¨æ„ `appsetting` and ç’°å¢ƒè®Šæ•¸ç²å–æ“ä½œ in project

note: å‰ç«¯ç›´æ¥ä½¿ç”¨ .env ä¾†è¨­ç½® URL å³å¯

## åœ°ç«¯æ¸¬è©¦ç’°å¢ƒè¨­ç½®

### user service

1. Clone the project.
2. Navigate to the user folder using `cd`.
3. Execute `make start`. (you probably may get error)
4. Ensure you have Golang 1.21 installed.
5. Run `make start` again. (you probably may get error)
6. Install the Swag CLI by using the command `go install github.com/swaggo/swag/cmd/swag@latest`.
7. Run `make start` again. (you probably may get error)
8. Install the `[gcloud](<https://cloud.google.com/sdk/docs/install>)` CLI and `[firebase-tool](<https://firebase.google.com/docs/cli?hl=zh-cn>)` (You don't need to log in to each tool as I only use the emulator in each one).
9. Install Java JDK; choose any version you prefer.
10. Run `make start`. (you probably may not get error)
11. Finally, you can obtain the emulator URL in the console.

if you have more question, please message me.

by the way, if you use firebase client SDK in frontend and try to login, please follow this

[å°†æ‚¨çš„åº”ç”¨è¿æ¥åˆ° Authentication æ¨¡æ‹Ÿå™¨ Â |Â  Firebase Local Emulator Suite](https://firebase.google.com/docs/emulator-suite/connect_auth?hl=zh-cn#web-namespaced-api)

<aside>
ğŸ’¡ simulator may not trigger pub/sub event, please edit [script](https://github.com/leon123858/tsmc-meal-order/blob/main/user/test/trigger-sync.js) to data you want and use `node trigger-sync.js` ********to execute it after new user first time login.

</aside>

## mail service

You do not need to create this service on-premises because this service does not have a strong dependency on the system. However, if you want to try it, please message Leon. He can help you create a real service in Google Cloud Platform while you are testing it.

## PostgreSQL - Flexible Server

- **Reference**

[How to enable and use pgvector - Azure Database for PostgreSQL - Flexible Server](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/how-to-use-pgvector)

- **Server Info**
    - Host: [menu.postgres.database.azure.com](http://menu.postgres.database.azure.com/)
    - UserName: db_user
    - Password: ï¼Šï¼Šï¼Šï¼Šï¼Šï¼Šï¼Šï¼Šï¼Š
    - ä»¥ä¸Šå¸³è™Ÿåªæœ‰é–‹å•Ÿ SELECT å’Œ INSERT æ¬Šé™ï¼Œå¦‚æœéœ€è¦ ALTER TABLE å†è·Ÿæˆ‘èªª
- **Table Info**

```sql
CREATE TABLE self_menu_embeddings(
    id bigserial PRIMARY KEY,
    menu_id varchar(50) NOT NULL,
    index int NOT NULL,
    embedding vector(768) NOT NULL
    );
```

- **Insert SQL**

```sql
insert into self_menu_embeddings(menu_id, index, embedding)
values ("menu id", 0, '[0,0,...,0]')
```

- **Select SQL**

```sql
select * from self_menu_embeddings
order by cosine_distance(embedding, '[0,0,.. user input embeddings ..,0]')
```
